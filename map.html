<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∂–∏–ª—å—è –≤ –ú–æ—Å–∫–≤–µ</title>
    <script src="https://maps.api.2gis.ru/2.0/loader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .header {
            background: #0088cc;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .controls {
            position: absolute;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        .controls.collapsed {
            transform: translateX(-350px);
        }
        .toggle-controls {
            background: #0088cc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-form {
            margin-bottom: 15px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background: #0088cc;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .tg-button {
            background: #2481cc;
            margin-top: 10px;
        }
        .results {
            margin-top: 15px;
        }
        .offer {
            border: 1px solid #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .offer:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .offer-high {
            border-left: 4px solid #4CAF50;
        }
        .offer-medium {
            border-left: 4px solid #FFC107;
        }
        .offer-low {
            border-left: 4px solid #F44336;
        }
        .price {
            font-weight: bold;
            color: #0088cc;
            font-size: 16px;
        }
        .score {
            float: right;
            background: #0088cc;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .offer-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .offer-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        .stats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .collapse-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .filter-section {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .filter-btn {
            flex: 1;
            min-width: 60px;
            padding: 8px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
        }
        .filter-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }
        .view-buttons {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        .view-btn {
            flex: 1;
            padding: 8px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        .view-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }
        .district-polygon {
            stroke: #333;
            stroke-width: 2;
            fill-opacity: 0.6;
        }
        .district-label {
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px white;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>üè† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∂–∏–ª—å—è –≤ –ú–æ—Å–∫–≤–µ</div>
        <button class="toggle-controls" onclick="toggleControls()">üìã –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
    </div>

    <div class="controls" id="controlsPanel">
        <button class="collapse-btn" onclick="toggleControls()">‚úï</button>

        <div class="search-form">
            <h3>üîç –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å–µ–º—å–∏</h3>

            <div class="filter-section">
                <h4>üë∂ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π</h4>
                <div class="filter-buttons" id="childrenCountButtons">
                    <div class="filter-btn active" data-value="any">–õ—é–±–æ–µ</div>
                    <div class="filter-btn" data-value="1">1 —Ä–µ–±—ë–Ω–æ–∫</div>
                    <div class="filter-btn" data-value="2">2 –¥–µ—Ç–µ–π</div>
                    <div class="filter-btn" data-value="3">3 –¥–µ—Ç–µ–π</div>
                    <div class="filter-btn" data-value="4">4+ –¥–µ—Ç–µ–π</div>
                </div>
            </div>

            <div class="filter-section">
                <h4>üéÇ –í–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π</h4>
                <div class="filter-buttons" id="childrenAgeButtons">
                    <div class="filter-btn active" data-value="any">–õ—é–±–æ–π</div>
                    <div class="filter-btn" data-value="0-5">0-5 –ª–µ—Ç</div>
                    <div class="filter-btn" data-value="5-14">5-14 –ª–µ—Ç</div>
                    <div class="filter-btn" data-value="14-18">14-18 –ª–µ—Ç</div>
                </div>
            </div>

            <div class="filter-section">
                <h4>üí∞ –¶–µ–Ω–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω</h4>
                <div class="filter-buttons" id="priceRangeButtons">
                    <div class="filter-btn active" data-value="any">–õ—é–±–æ–π</div>
                    <div class="filter-btn" data-value="low">–¥–æ 60 —Ç—ã—Å.</div>
                    <div class="filter-btn" data-value="medium">60-90 —Ç—ã—Å.</div>
                    <div class="filter-btn" data-value="high">–≤—ã—à–µ 90 —Ç—ã—Å.</div>
                </div>
            </div>

            <div class="filter-section">
                <h4>üö™ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</h4>
                <div class="filter-buttons" id="roomsButtons">
                    <div class="filter-btn active" data-value="any">–õ—é–±–æ–µ</div>
                    <div class="filter-btn" data-value="studio">–°—Ç—É–¥–∏—è</div>
                    <div class="filter-btn" data-value="1">1 –∫–æ–º–Ω–∞—Ç–∞</div>
                    <div class="filter-btn" data-value="2">2 –∫–æ–º–Ω–∞—Ç—ã</div>
                    <div class="filter-btn" data-value="3+">3+ –∫–æ–º–Ω–∞—Ç—ã</div>
                </div>
            </div>

            <button id="searchButton">üéØ –ù–∞–π—Ç–∏ –∂–∏–ª—å–µ</button>
            <button id="showAllButton">üîÑ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
            <button id="clearButton">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div class="stats" id="searchStats" style="display: none;">
            <div id="statsContent"></div>
        </div>

        <div class="results" id="resultsContainer">
            <div class="loading" id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</div>
            <div id="resultsContent" style="display: none;">
                <h4>üèòÔ∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: <span id="offersCount">0</span></h4>
                <div id="offersList"></div>
            </div>
        </div>

        <button class="tg-button" id="shareButton">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏</button>
    </div>

    <div id="map"></div>

    <script>
        const DG_TOKEN = 'c2a3254a-5e7e-4d42-8414-5c35acdeae35';
        let map;
        let userMarker;
        let currentOffers = [];
        let offerMarkers = [];
        let districtLayers = [];
        let currentViewMode = 'heatmap'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        let elements = {};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS
        function initMap() {
            DG.then(function() {
                map = DG.map('map', {
                    center: [55.82, 37.42], // –¶–µ–Ω—Ç—Ä –°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞
                    zoom: 12
                });

                console.log('–ö–∞—Ä—Ç–∞ 2GIS —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                loadDistrictHeatmap();

            }).catch(function(error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã 2GIS:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function initElements() {
            elements = {
                loadingIndicator: document.getElementById('loadingIndicator'),
                resultsContent: document.getElementById('resultsContent'),
                offersList: document.getElementById('offersList'),
                offersCount: document.getElementById('offersCount'),
                searchStats: document.getElementById('searchStats'),
                statsContent: document.getElementById('statsContent'),
                searchButton: document.getElementById('searchButton'),
                showAllButton: document.getElementById('showAllButton'),
                clearButton: document.getElementById('clearButton'),
                shareButton: document.getElementById('shareButton'),
                controlsPanel: document.getElementById('controlsPanel'),
                childrenCountButtons: document.getElementById('childrenCountButtons'),
                childrenAgeButtons: document.getElementById('childrenAgeButtons'),
                priceRangeButtons: document.getElementById('priceRangeButtons'),
                roomsButtons: document.getElementById('roomsButtons')
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
            for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    console.error(`–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ${key}`);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filterContainers = [
                'childrenCountButtons',
                'childrenAgeButtons',
                'priceRangeButtons',
                'roomsButtons'
            ];

            filterContainers.forEach(containerId => {
                if (elements[containerId]) {
                    elements[containerId].addEventListener('click', function(e) {
                        if (e.target.classList.contains('filter-btn')) {
                            const container = e.target.parentElement;
                            container.querySelectorAll('.filter-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            e.target.classList.add('active');
                        }
                    });
                }
            });

            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            if (elements.searchButton) {
                elements.searchButton.addEventListener('click', searchHousing);
            }
            if (elements.showAllButton) {
                elements.showAllButton.addEventListener('click', loadAllOffers);
            }
            if (elements.clearButton) {
                elements.clearButton.addEventListener('click', clearSearch);
            }
            if (elements.shareButton) {
                elements.shareButton.addEventListener('click', shareLocation);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã —Ä–∞–π–æ–Ω–æ–≤
        async function loadDistrictHeatmap(filters = {}) {
            showLoading(true);

            try {
                const response = await fetch('/api/district_heatmap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const districtData = await response.json();
                displayDistrictHeatmap(districtData);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã —Ä–∞–π–æ–Ω–æ–≤
        function displayDistrictHeatmap(districtData) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–ª–æ–∏
            clearOfferMarkers();
            clearDistrictLayers();

            if (districtData.length === 0) {
                console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–≤–µ—Ç–æ–≤
            const maxCount = Math.max(...districtData.map(d => d.count));

            districtData.forEach(district => {
                const intensity = district.intensity || Math.min(100, (district.count / maxCount) * 100);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
                let color;
                if (intensity > 75) color = '#ff4444'; // –ö—Ä–∞—Å–Ω—ã–π - –º–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                else if (intensity > 50) color = '#ffaa00'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                else if (intensity > 25) color = '#ffff00'; // –ñ–µ–ª—Ç—ã–π
                else color = '#88ff88'; // –ó–µ–ª–µ–Ω—ã–π - –º–∞–ª–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω —Ä–∞–π–æ–Ω–∞
                if (district.bounds && district.bounds.length === 2) {
                    const bounds = [district.bounds[0], district.bounds[1]];
                    const polygon = DG.rectangle(bounds, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        weight: 2
                    }).addTo(map);

                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                    const label = DG.marker(district.coordinates, {
                        icon: DG.divIcon({
                            html: `
                                <div style="
                                    background: white;
                                    padding: 5px 10px;
                                    border: 2px solid ${color};
                                    border-radius: 15px;
                                    font-weight: bold;
                                    color: #333;
                                    text-align: center;
                                ">
                                    <div>${district.district}</div>
                                    <div style="font-size: 12px; color: #666;">
                                        ${district.count} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                                    </div>
                                </div>
                            `,
                            className: 'district-label',
                            iconSize: [100, 40]
                        })
                    }).addTo(map);

                    districtLayers.push(polygon);
                    districtLayers.push(label);

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                    polygon.bindPopup(`
                        <div style="min-width: 200px;">
                            <h3>${district.district}</h3>
                            <p><strong>${district.count} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</strong></p>
                            <p>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${intensity}%</p>
                            <p>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ${district.avg_price ? district.avg_price.toLocaleString() + ' —Ä—É–±' : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                            <p>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ${district.avg_score || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}/100</p>
                        </div>
                    `);
                }
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—Å–µ—Ö —Ä–∞–π–æ–Ω–∞—Ö
            if (districtData.length > 0 && districtData[0].bounds) {
                const allBounds = districtData.map(d => d.bounds).flat();
                const group = DG.featureGroup(districtLayers);
                map.fitBounds(group.getBounds());
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateHeatmapStats(districtData);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
        function updateHeatmapStats(districtData) {
            if (!elements.searchStats || !elements.statsContent) return;

            const totalOffers = districtData.reduce((sum, district) => sum + district.count, 0);
            const districtsWithOffers = districtData.filter(d => d.count > 0).length;
            const mostPopularDistrict = districtData.reduce((max, district) =>
                district.count > max.count ? district : max, {count: 0, district: '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
            );

            elements.statsContent.innerHTML = `
                <strong>üìä –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞–π–æ–Ω–æ–≤:</strong><br>
                ‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${totalOffers}<br>
                ‚Ä¢ –†–∞–π–æ–Ω–æ–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏: ${districtsWithOffers}<br>
                ‚Ä¢ –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π: ${mostPopularDistrict.district} (${mostPopularDistrict.count} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)<br>
                ‚Ä¢ –¶–≤–µ—Ç–æ–≤–∞—è —à–∫–∞–ª–∞: üü¢ –º–∞–ª–æ ‚Üí üü° —Å—Ä–µ–¥–Ω–µ ‚Üí üü† –º–Ω–æ–≥–æ ‚Üí üî¥ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ
            `;

            elements.searchStats.style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–º–∞—Ä–∫–µ—Ä—ã)
        async function loadAllOffers() {
            showLoading(true);

            try {
                const response = await fetch('/api/all_offers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                currentOffers = data.offers || [];

                showSearchStats(data, true);
                displayOffers(currentOffers);
                showOffersOnMap(currentOffers);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // –ü–æ–∏—Å–∫ –∂–∏–ª—å—è
        async function searchHousing() {
            const childrenCount = getActiveFilterValue('childrenCountButtons');
            const childrenAge = getActiveFilterValue('childrenAgeButtons');
            const priceRange = getActiveFilterValue('priceRangeButtons');
            const rooms = getActiveFilterValue('roomsButtons');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
            await loadDistrictHeatmap({
                children_count: childrenCount,
                children_age: childrenAge,
                price_range: priceRange,
                rooms: rooms
            });

            // –¢–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å–ø–∏—Å–∫–∞
            await loadFilteredOffers({
                children_count: childrenCount,
                children_age: childrenAge,
                price_range: priceRange,
                rooms: rooms
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        async function loadFilteredOffers(filters) {
            try {
                const response = await fetch('/api/search_housing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentOffers = data.offers || [];

                showSearchStats(data, false);
                displayOffers(currentOffers);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        function getActiveFilterValue(containerId) {
            if (!elements[containerId]) return 'any';
            const activeBtn = elements[containerId].querySelector('.filter-btn.active');
            return activeBtn ? activeBtn.dataset.value : 'any';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∏—Å–∫–∞
        function showSearchStats(data, isAllOffers) {
            if (!elements.searchStats || !elements.statsContent) return;

            const offers = data.offers || [];
            const avgPrice = offers.length > 0 ?
                Math.round(offers.reduce((sum, offer) => sum + offer.price, 0) / offers.length) : 0;
            const avgArea = offers.length > 0 ?
                Math.round(offers.reduce((sum, offer) => sum + offer.area, 0) / offers.length) : 0;

            const title = isAllOffers ? "üìà –í—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:" : "üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:";

            elements.statsContent.innerHTML = `
                <strong>${title}</strong><br>
                ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ: ${data.total_found || 0} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π<br>
                ‚Ä¢ –ü–æ–∫–∞–∑–∞–Ω–æ: ${offers.length} –ª—É—á—à–∏—Ö<br>
                ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ${avgPrice.toLocaleString()} —Ä—É–±<br>
                ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –ø–ª–æ—â–∞–¥—å: ${avgArea} –º¬≤
            `;

            elements.searchStats.style.display = 'block';
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
        function displayOffers(offers) {
            if (!elements.loadingIndicator || !elements.resultsContent || !elements.offersList || !elements.offersCount) {
                console.error('DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            elements.offersList.innerHTML = '';
            elements.offersCount.textContent = offers.length;

            if (offers.length === 0) {
                elements.offersList.innerHTML = '<p style="text-align: center; color: #666;">üòî –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            } else {
                offers.forEach((offer, index) => {
                    const offerElement = document.createElement('div');
                    offerElement.className = `offer ${getOfferClass(offer.score || 50)}`;
                    offerElement.innerHTML = `
                        <div class="score">${offer.score || 50}</div>
                        <div class="price">${offer.price.toLocaleString()} —Ä—É–±</div>
                        <div class="offer-title">${offer.title || '–ö–≤–∞—Ä—Ç–∏—Ä–∞'}</div>
                        <div class="offer-details">
                            üè† ${offer.rooms} –∫–æ–º–Ω. ‚Ä¢ ${offer.area} –º¬≤ ‚Ä¢ ${offer.price_per_m2?.toLocaleString()} —Ä—É–±/–º¬≤<br>
                            ${offer.metro ? `üöá ${offer.metro} ‚Ä¢ ${offer.metro_time} –º–∏–Ω –ø–µ—à–∫–æ–º<br>` : ''}
                            üìç ${offer.address ? offer.address.split(', ').slice(-2).join(', ') : '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}<br>
                            ${offer.district ? `üèòÔ∏è ${offer.district}` : ''}
                        </div>
                    `;

                    offerElement.addEventListener('click', () => showOfferOnMap(offer, index));
                    elements.offersList.appendChild(offerElement);
                });
            }

            elements.loadingIndicator.style.display = 'none';
            elements.resultsContent.style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ (–º–∞—Ä–∫–µ—Ä—ã)
        function showOffersOnMap(offers) {
            clearOfferMarkers();
            clearDistrictLayers();

            if (offers.length === 0) return;

            offers.forEach((offer, index) => {
                const marker = DG.marker(offer.coordinates || [55.82, 37.42])
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 250px;">
                            <h4>${offer.rooms} –∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞</h4>
                            <p><strong>${offer.price.toLocaleString()} —Ä—É–±</strong></p>
                            <p>${offer.area} –º¬≤ ‚Ä¢ ${offer.price_per_m2?.toLocaleString()} —Ä—É–±/–º¬≤</p>
                            <p>${offer.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                            ${offer.metro ? `<p>üöá ${offer.metro} ‚Ä¢ ${offer.metro_time} –º–∏–Ω –ø–µ—à–∫–æ–º</p>` : ''}
                            ${offer.district ? `<p>üèòÔ∏è ${offer.district}</p>` : ''}
                            <p>‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${offer.score || 50}</p>
                            ${offer.title ? `<p><em>${offer.title}</em></p>` : ''}
                            <button onclick="selectOffer(${index})" style="width: 100%; padding: 8px; background: #0088cc; color: white; border: none; border-radius: 4px; cursor: pointer;">–í—ã–±—Ä–∞—Ç—å</button>
                        </div>
                    `);

                // –¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
                const markerIcon = marker.getElement().querySelector('.leaflet-marker-icon');
                if (markerIcon) {
                    const score = offer.score || 50;
                    if (score > 70) {
                        markerIcon.style.filter = 'hue-rotate(120deg)';
                    } else if (score > 50) {
                        markerIcon.style.filter = 'hue-rotate(60deg)';
                    }
                }

                offerMarkers.push(marker);
            });

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö
            if (offers.length > 0) {
                const group = DG.featureGroup(offerMarkers);
                map.fitBounds(group.getBounds());
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        function clearOfferMarkers() {
            offerMarkers.forEach(marker => {
                if (map && marker) {
                    map.removeLayer(marker);
                }
            });
            offerMarkers = [];
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–∏ —Ä–∞–π–æ–Ω–æ–≤
        function clearDistrictLayers() {
            districtLayers.forEach(layer => {
                if (map && layer) {
                    map.removeLayer(layer);
                }
            });
            districtLayers = [];
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        function showOfferOnMap(offer, index) {
            if (offer.coordinates) {
                map.setView(offer.coordinates, 16);
                if (offerMarkers[index]) {
                    offerMarkers[index].openPopup();
                }
            }
        }

        function selectOffer(index) {
            const offer = currentOffers[index];
            alert(`üè† –í—ã–±—Ä–∞–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞:\n${offer.title || '–ö–≤–∞—Ä—Ç–∏—Ä–∞'}\nüìç ${offer.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}\nüí∞ ${offer.price.toLocaleString()} —Ä—É–±\nüìè ${offer.area} –º¬≤`);
        }

        function getOfferClass(score) {
            if (score > 70) return 'offer-high';
            if (score > 50) return 'offer-medium';
            return 'offer-low';
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function toggleControls() {
            if (elements.controlsPanel) {
                elements.controlsPanel.classList.toggle('collapsed');
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
        function clearSearch() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
            const filterContainers = [
                'childrenCountButtons',
                'childrenAgeButtons',
                'priceRangeButtons',
                'roomsButtons'
            ];

            filterContainers.forEach(containerId => {
                if (elements[containerId]) {
                    const firstBtn = elements[containerId].querySelector('.filter-btn');
                    elements[containerId].querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    if (firstBtn) {
                        firstBtn.classList.add('active');
                    }
                }
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            loadDistrictHeatmap();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading(show) {
            if (!elements.loadingIndicator || !elements.resultsContent) return;

            if (show) {
                elements.loadingIndicator.style.display = 'block';
                elements.resultsContent.style.display = 'none';
            } else {
                elements.loadingIndicator.style.display = 'none';
            }
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        function shareLocation() {
            alert('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ Telegram –≤–µ—Ä—Å–∏–∏');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º...');
            initElements();
            initEventListeners();
            initMap();
        });
    </script>
</body>
</html>