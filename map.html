<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2GIS Map MiniApp</title>
    <script src="https://maps.api.2gis.ru/2.0/loader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .header {
            background: #0088cc;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .controls {
            position: absolute;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .tg-button {
            background: #2481cc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        üó∫Ô∏è –ö–∞—Ä—Ç–∞ 2GIS –≤ Telegram
    </div>

    <div class="controls">
        <button onclick="findMyLocation()">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        <button onclick="searchPlace()">üîç –ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞</button>
        <button class="tg-button" onclick="shareLocation()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π</button>
    </div>

    <div id="map"></div>

    <script>
        // –¢–æ–∫–µ–Ω 2GIS
        const DG_TOKEN = 'c2a3254a-5e7e-4d42-8414-5c35acdeae35';
        let map;
        let userMarker;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS
        DG.then(function() {
            map = DG.map('map', {
                center: [55.7558, 37.6173], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                zoom: 13
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∏—Å–∫ 2GIS
            DG.control.location({
                position: 'topright'
            }).addTo(map);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            initTelegramApp();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Mini App
        function initTelegramApp() {
            if (window.Telegram && Telegram.WebApp) {
                const tg = Telegram.WebApp;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                tg.ready();
                tg.expand();

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                tg.MainButton.setText("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π").show();
                tg.MainButton.onClick(shareLocation);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    tg.close();
                });

                console.log('Telegram Web App initialized');
            }
        }

        // –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        function findMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }

                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
                        map.setView([lat, lng], 15);

                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                        userMarker = DG.marker([lat, lng]).addTo(map)
                            .bindPopup('üìç –í—ã –∑–¥–µ—Å—å!')
                            .openPopup();
                    },
                    function(error) {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è GPS.');
                    }
                );
            } else {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
            }
        }

        // –ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ 2GIS
        function searchPlace() {
            const query = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∫–∞—Ñ–µ", "–∞–ø—Ç–µ–∫–∞"):');
            if (query) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ 2GIS
                DG.search(query, {
                    map: map,
                    zoom: 15
                });
            }
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π –≤ Telegram
        function shareLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
                        if (window.Telegram && Telegram.WebApp) {
                            Telegram.WebApp.sendData(JSON.stringify({
                                action: 'share_location',
                                lat: lat,
                                lng: lng,
                                message: `–ú–æ—è –ª–æ–∫–∞—Ü–∏—è: ${lat.toFixed(6)}, ${lng.toFixed(6)}`
                            }));
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                            alert(`–í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:\n–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}\n–î–æ–ª–≥–æ—Ç–∞: ${lng.toFixed(6)}`);
                        }
                    },
                    function(error) {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                    }
                );
            } else {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Telegram
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
            }
        });
    </script>
</body>
</html>